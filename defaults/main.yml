---

telegraf_influxdata_base_url: https://repos.influxdata.com
telegraf_enable_snmp: false
# If yes, service will be started. Will not be started if set to no.
telegraf_start_service: true
telegraf_start_delay: 6

# If yes, will overwrite the packaged configuration with an Asnible/jinja2 template
telegraf_template_configuration: true

# Path for finding Telegraf data. Added for backwards-compatibility.
telegraf_binary_path: /usr/bin/telegraf
telegraf_configuration_dir: /etc/telegraf
telegraf_config_file: telegraf.conf

# Channel of Telegraf to install
telegraf_install_version: stable

# The user and group telegraf should run under (should be set to telegraf unless needed otherwise)
telegraf_runas_user: root
telegraf_runas_group: root

# Configuration Variables
telegraf_tags:
telegraf_aws_tags: false
telegraf_aws_tags_prefix:
# Configuration Template
telegraf_configuration_template: telegraf.conf.j2

telegraf_agent_configs:
  interval: 15s
  round_interval: "true"
  metric_batch_size: 10000
  metric_buffer_limit: 50000
  collection_jitter: 2s
  flush_interval: 10s
  flush_jitter: 5s
  debug: "false"
  quiet: "true"
  omit_hostname: "false"
  hostname: "{{ ansible_hostname }}"

#### Telegraf InfluxDB v2 Output
influxdb2_server_ip: 0.0.0.0
telegraf_influxdb2_default_url: http://{{ influxdb2_server_ip }}:8086
telegraf_influxdb2_organization: constructorfleet
telegraf_influxdb2_bucket: telegraf
telegraf_influxdb2_timeout: 30s
telegraf_influxdb2_bucket_tag: ""
telegraf_influxdb2_exclude_bucket_tag: "false"
telegraf_influxdb2_http_headers: ""
telegraf_influxdb2_http_proxy: ""
telegraf_influxdb2_user_agent: telegraf
telegraf_influxdb2_content_encoding: gzip
telegraf_influxdb2_influx_uint_support: "false"
telegraf_influxdb2_tls_cert: "{{ ssl_certpath | default('/etc/ssl/certs/my.cert') }}"
telegraf_influxdb2_tls_key: "{{ ssl_keypath | default('/etc/private/ssl/my.key') }}"
telegraf_influxdb2_insecure_skip_verify: "true"

## ENVIRONMENT VARIABLES SET IN /etc/default/telegraf USED IN CONFIG FILE
telegraf_env:
  INFLUX_HOST: "{{ telegraf_influxdb2_default_url }}"
  INFLUX_ORG: default
  INFLUX_TELEGRAF_TOKEN: "{{ vault_influxdb2_telegraf_metrics_token }}"
  INFLUX_LOGS_TOKEN: "{{ vault_influxdb2_telegraf_logs_token }}"
  INFLUX_LOKI_HOST: "{{ loki_default_url }}"

### EXAMPLE OUTPUT CONFIGS

telegraf_output_plugins:
  - name: influxdb_v2
    options:
      alias: telegraf
      urls:
        - "http://10.0.10.100:8086"
      token: "{{ vault_influxdb2_telegraf_metrics_token }}"
      organization: "constructorfleet"
      exclude_bucket_tag: "false"
      bucket: telegraf
      timeout: 30s
      ping_timeout: 15s
      read_idle_timeout: 30s
      user_agent: telegraf
      content_encoding: gzip
      influx_uint_support: "false"
      insecure_skip_verify: "false"

  - name: influxdb_v2
    options:
      alias: influxdb3-telegraf
      urls:
        - "http://10.0.10.100:8181"
      token: "{{ vault_influxdb3_operator_token }}"
      organization: ""
      bucket: "telegraf"
      timeout: 30s
      ping_timeout: 15s
      read_idle_timeout: 30s
      user_agent: telegraf
      content_encoding: gzip
      influx_uint_support: "true"
      insecure_skip_verify: "false"

  - name: http
    options:
      url: "http://10.0.10.100:8428/api/v1/write"
      method: "POST"
      data_format: "prometheusremotewrite"
      timeout: "30s"
      idle_conn_timeout: "90s"
      namedrop:
        - "syslog"
        - "tail"
        - "nginx_access_log"
      headers:
        options:
          Content-Type: "application/x-protobuf"
          Content-Encoding: "snappy"
          X-Prometheus-Remote-Write-Version: "0.1.0"

  - name: influxdb
    options:
      alias: VictoriaMetrics
      urls:
        - http://10.0.10.100:8428
      database: telegraf
      timeout: 10s
      content_encoding: gzip
      influx_uint_support: "true"
      skip_database_creation: "false"
      exclude_retention_policy_tag: "true"
      namedrop:
        - syslog
        - tail
        - nginx_json
        - nginx_access_log

  - name: loki
    options:
      alias: VictoriaLogs
      domain: "http://10.0.10.100:9428"
      endpoint: "/insert/loki/api/v1/push"
      timeout: "10s"
      namepass:
        - syslog
        - tail
        - nginx_json
        - nginx_access_log
        - netflow

  - name: elasticsearch
    options:
      urls:
        - http://10.0.10.100:9428/insert/elasticsearch
      timeout: 1m
      flush_interval: 30s
      enable_sniffer: "false"
      health_check_interval: "0s"
      index_name: "device_log-%Y.%m.%d"
      manage_template: "false"
      template_name: telegraf
      overwrite_template: "false"
      namepass:
        - syslog
        - tail
        - nginx_access_log
      headers:
        options:
          VL-Msg-Field: tail.value
          VL-Time-Field: "@timestamp"
          VL-Stream-Fields: "tag.log_source,tag.metric_type"

  - name: http
    options:
      url: "{{ prometheus_default_url }}"
      data_format: "{{ prometheus_data_format }}"
      headers:
        Content-Type: application/x-protobuf
        Content-Encoding: snappy
        X-Prometheus-Remote-Write-Version: "0.1.0"

# Base telegraf configuration override
telegraf_plugins_base:
  - name: system
  - name: cpu
    options:
      percpu: "true"
      totalcpu: "true"
      fieldexclude:
        - time_*
  - name: mem
  - name: net
  - name: nstat
    options:
      proc_net_netstat: /proc/net/netstat
      proc_net_snmp: /proc/net/snmp
      dump_zeros: "true"
  - name: netstat
  - name: disk
    options:
      ignore_fs:
        - autofs
        - binfmt_misc
        - bpf
        - ceph
        - cgroup2
        - configfs
        - debugfs
        - devpts
        - devtmpfs
        - efivarfs
        - hugetlbfs
        - mqueue
        - proc
        - pstore
        - ramfs
        - rpc_pipefs
        - securityfs
        - sysfs
        - tmpfs
        - devfs
        - devtmpfs
        - tracefs
        - overlay
        - overlay2
        - mdev
        - squashfs
        - raid_member
        - nfs
        - nfs4
        - iso9660
  - name: diskio
    options:
      skip_serial_number: "false"
      devices:
        - sd*
        - rbd*
        - dm*
        - nvme*
  - name: swap
  - name: processes
  - name: kernel
  - name: kernel_vmstat
  - name: internal
    options:
      collect_memstats: "true"
  - name: syslog
    options:
      server: tcp4://:5140
      syslog_standard: RFC5424
      framing: octet-counting
      best_effort: "true"
      keep_alive_period: 5m
      read_timeout: 0
      trailer: LF
  - name: x509_cert
    options:
      sources:
        - https://nginx.home.prettybaked.com
        - https://pvedash.home.prettybaked.com
        - https://ceph.home.prettybaked.com
        - https://traefik.home.prettybaked.com
        - https://authentik.prettybaked.com
        - https://plex.home.prettybaked.com
        - https://plex.prettybaked.com
        - https://requests.prettybaked.com
        - https://tautulli.prettybaked.com

telegraf_plugins: "{{ telegraf_plugins_base + telegraf_plugins_extra | default([]) }}"

snmp_pkgs:
  - snmp
  - libsnmp-base
  - snmp-mibs-downloader

metrics_pkgs:
  - sysstat
  - dstat
  - ifstat
  - lm-sensors
  - smartmontools
  - htop
  - ipmitool
  - ethtool
  - net-tools

# Example Grok Patterns for use with logparser input
# Works with default nginx 'main' log and 'fail2ban.log' configured by ansible-nginx role.
# nginx_accesslog_grokpattern: '%{CLIENT:client_ip} - %{NOTSPACE:ident} \[%{HTTPDATE:ts:ts-httpd}\] %{NOTSPACE:request_host:tag} "(?:%{WORD:verb:tag} %{NOTSPACE:request} (?:HTTP/%{NUMBER:http_version:float})?|%{DATA})" %{NUMBER:resp_code:tag} (?:%{NUMBER:resp_bytes:int}|-) "%{NOTSPACE:referrer}" "%{DATA:agent:tag}" (?:%{NUMBER:request_time}|-) (?:%{NUMBER:upstream_connect_time}|-) %{NOTSPACE:x_forwarded_for} %{NOTSPACE:upstream_cache_status:tag}'
# fail2ban_banlog_grokpattern: '%{TIMESTAMP_ISO8601:timestamp} %{WORD:log_src}.%{WORD:src_action} *\[%{INT:fail2ban_digit}\]: %{WORD:loglevel:tag} *\[%{NOTSPACE:service:tag}\] %{GREEDYDATA:ban_status:tag} %{IP:clientip:tag}'
